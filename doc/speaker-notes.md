# Spring Boot 単体テストワークショップ 口頭台本（スピーカーノーツ拡張）

この台本は doc/slides.md の各章に対応し、講師がそのまま読み上げ・操作できる粒度で記載しています。時間配分は目安です。実演時は常に「対象ファイル・実行コマンド・検証観点」を明示してください。

## 0. 開始前チェック（2分）
- セリフ:「それでは始めます。今日は、このリポジトリに含まれているコードだけを使って、Spring Boot の単体テストを段階的に学びます。」
- 操作: ターミナルで `./mvnw -v` を実行し、Maven と JDK 21 を表示。
- セリフ:「環境は Maven Wrapper を使います。JDK は 21 です。では進めましょう。」

【ランタイムデモの用意】
- セリフ:「Web の章では、まず curl で実際の挙動を見てから、テストコードでどう検証しているかを確認します。」
- 操作: ターミナル1で `./mvnw spring-boot:run` を実行し、サーバを起動したままにする。
- 操作: ターミナル2を用意して、以降の curl を実行。終了時はサーバ側で `Ctrl + C`。

## 1. オリエンテーション（5分）
- セリフ:「まずは全体像です。単体テスト、Web 層スライス、MyBatis スライス、最後に起動確認を扱います。」
- 画面共有: `pom.xml` を開く。
- 話す例文:
  - 「`spring-boot-starter-test`、`mybatis-spring-boot-starter-test`、そしてテンプレート検証用に `jsoup` が入っています。」
  - 「テストコードは `src/test/java` にまとまっていて、本体と同じパッケージ構成です。」
- 操作: `./mvnw test` を実行。
- セリフ:「まずは全テストがグリーンであることを確認しました。これを基準に学んでいきます。」
- 返し例:「IDE でも同様に動きます。個別実行も可能です。」

## 2. JUnit 基本とアサーション（10分）
- 画面共有: `src/test/java/.../service/CalcServiceTest.java` を開く。
- セリフ（導入）:「JUnit の基本です。`@Test` メソッドで、期待値と実測値を `assertEquals` で比べます。」
- 操作: ターミナルで `./mvnw -Dtest=CalcServiceTest test` を実行。
- セリフ（解説）:
  - 「Arrange-Act-Assert の順で書いています。入力が 1 と 2、期待値が 3。」
  - 「失敗時は『期待: 3 実際: 4』のように表示されます。」
- 失敗デモ（任意・短く）:
  - 操作: 期待値を 4 に変更→再実行→すぐ 3 に戻す。
  - セリフ:「失敗出力はデバッグの道しるべ。すぐに元に戻します。」
- 返し例:「浮動小数の誤差問題は今回は扱いません。まずは整数で型を掴みます。」

## 3. ライフサイクル（5分）
- 画面共有: 同テストの `@BeforeEach` / `@AfterEach` を指し示す。
- セリフ:「テスト前後のフックです。今回は空ですが、セットアップと後始末の置き場を理解しておきましょう。」
- 操作: 実行は不要。必要なら `./mvnw -Dtest=CalcServiceTest test` を再実行。
- 返し例:「クラス全体の前後は `BeforeAll/AfterAll` ですが、本リポジトリでは使っていません。」

## 4. 純粋ユニットテスト（5分）
- セリフ（導入）:「依存のないクラスは、フレームワークに載せず、直接 new して速く回します。」
- 画面共有: `CalcService` の `add` 実装を表示。
- セリフ（解説）:「小さく速いテストは、日々の開発で最もよく触れる層です。」
- 操作: 実行は省略可（前章で実施済）。
- 返し例:「private メソッドは公開メソッド経由で間接的に検証します。」

## 5. Mockito でサービス単体（15分）
- 画面共有: `src/test/java/.../service/UserServiceTest.java` を開く。
- セリフ（導入）:「次は依存をモックするパターンです。`UserService` が `UserMapper` に依存しています。」
- 話す例文:
  - 「`@ExtendWith(MockitoExtension.class)` で Mockito を有効化します。」
  - 「`@Mock` で Mapper をモック化し、`when(...).thenReturn(...)` で戻り値を定義します。」
  - 「例外は `assertThrows` で期待を表現できます。」
- 操作: `./mvnw -Dtest=UserServiceTest test` 実行。
- セリフ（解説）:「`reset(mapper)` はテスト間の副作用を断つのに有効です。」
- 返し例:「スタブとモックの違いは、振る舞いの定義と呼び出し検証の観点の違いです。」

## 6. Web 層スライス（REST・文字列）（10分）
- 画面共有: `EchoController` → `src/test/java/.../controller/EchoControllerTest.java`。
- セリフ（導入）:「最初に curl で実際の挙動を見て、次にテストで同じ期待をどう表現しているかを見ます。」
- 操作（curl）: `curl 'http://localhost:8080/echo?message=12345'` → 出力 `12345`
- セリフ（橋渡し）:「今確認した結果をテストではこう書きます。」
- 話す例文:
  - 「`@WebMvcTest` は Web コンテキストのみを起動するスライステストです。」
  - 「`MockMvc` で `GET /echo` を組み立て、`status().isOk()` と `content().string("12345")` を検証します。」
- 操作（テスト）: `./mvnw -Dtest=EchoControllerTest test`
- 返し例:「バリデーションは今回は範囲外。入出力の最小セットに集中します。」

## 7. テンプレート出力の検証（15分）
- 画面共有: `IndexController` と `templates/index.html` → `IndexControllerTest`。
- セリフ（導入）:「まず curl で HTML を確認します。続けてテストでどこをどう検証しているかを見ます。」
- 操作（curl）:
  - `curl 'http://localhost:8080/index'`（`Hello, World!!!` を含む HTML）
  - `curl 'http://localhost:8080/index?name=12345'`（`Hello, 12345!!!` を含む HTML）
- セリフ（橋渡し）:「画面の `#message` に注目。テストでは DOM セレクタでここだけ確認します。」
- 話す例文:
  - 「`MockMvc` でレスポンス HTML を取得し、Jsoup でパースします。」
  - 「`doc.selectFirst("#message").text()` が期待文言かを比較しています。」
- 操作（テスト）: `./mvnw -Dtest=IndexControllerTest test`
- 返し例:「他の要素も同様に検証できますが、今日は見出しのみ扱います。」

## 8. サービス連携モック + 引数検証（20分）
- 画面共有: `CalcController` → `CalcService` → `CalcControllerTest`。
- セリフ（導入）:「まずランタイムの動きを見ます。」
- 操作（curl）: `curl 'http://localhost:8080/add?a=1&b=2'` → 出力 `3`
- セリフ（橋渡し）:「結果は 3。テストでは結果に加え、サービス呼び出し時の引数も確認します。」
- 話す例文:
  - 「`@MockitoBean` でサービスをモック化し、`when(service.add(...)).thenReturn(3)` で応答を固定します。」
  - 「`verify` と `ArgumentCaptor` で `a=1`, `b=2` が渡ったことを検証しています。」
- 操作（テスト）: `./mvnw -Dtest=CalcControllerTest test`
- 返し例:「呼び出し順序の検証も可能ですが、今回は引数の正しさに焦点を当てます。」

## 9. JSON レスポンス検証（5分）
- 画面共有: `UserController` → `UserService` → `UserControllerTest`。
- セリフ（導入）:「先にランタイムで返る JSON を確認します。」
- 操作（curl）: `curl 'http://localhost:8080/users'`（H2 のデータが返る）
- セリフ（橋渡し）:「この JSON を、テストでは最小限の方法で検証しています。」
- 話す例文:
  - 「`@MockitoBean` で `UserService` をモックし、期待する `List<User>` を返すようにします。」
  - 「`content().string("[...] ")` で JSON を文字列比較しています。」
- 操作（テスト）: `./mvnw -Dtest=UserControllerTest test`
- 返し例:「プロパティ順は今回固定。高度な検証は別章で扱えます。」

## 10. MyBatis リポジトリスライス（20分）
- 画面共有: 直前の `/users` の JSON を想起させ、裏で DB アクセスが走っていることを伝える。
- セリフ（導入）:「リポジトリ単体では、より小さく・速く・制御しやすく検証します。」
- 話す例文:
  - 「`@MybatisTest` は Mapper だけを起動するスライステストです。」
  - 「`@Sql` でテスト用データを投入し、件数・順序・値を厳密に確認します。」
- 操作（テスト）: `./mvnw -Dtest=UserMapperTest test`
- 返し例:「処理はロールバックされるため、テスト間の独立性が保たれます。」

## 11. コンテキスト起動（Smoke）（5分）
- 画面共有: `TestApplicationTests`。
- セリフ（導入）:「最後に、アプリケーションコンテキストが起動するかだけを確認します。」
- 話す例文:
  - 「ここでは詳細な挙動は見ません。『起動する』こと自体が価値です。」
- 操作: `./mvnw -Dtest=TestApplicationTests test` 実行。
- 返し例:「組み合わせや E2E は別レイヤーの関心として切り分けます。」

## 12. まとめと運用 Tips（5分）
- セリフ（まとめ）:
  - 「ユニット→スライス→起動の順で、速さと確実さを両立させます。」
  - 「全体／個別／パッケージの実行コマンドを使い分け、日常開発にテストを組み込みましょう。」
  - 「テストは最小の仕様ドキュメントです。読みやすい命名と一貫性を意識してください。」
- クロージング例文:「以上でワークショップは終了です。ご質問があればどうぞ。」

---

進行時のコツ（再掲・口上つき）
- セリフ:「これから見る対象クラスとテスト、そして実行コマンドを毎回お伝えします。」
- セリフ:「失敗デモは短く。すぐに元に戻しますので安心してください。」
- セリフ:「時間配分は章 7 と 10 が伸びやすいので、適宜ショートカットします。」
